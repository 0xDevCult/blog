---
import { getCollection } from 'astro:content';
import { getPostFrontmatter } from '../utils/get-post-frontmatter.ts';

// Get all posts
const posts = await getCollection('docs', ({ id }) => {
  return id.startsWith('posts/');
});

// Enhance posts with frontmatter from markdown files
const postsWithFrontmatter = posts.map((post) => {
  const frontmatter = getPostFrontmatter(post.id);
  return {
    ...post,
    frontmatter,
  };
});

// Sort by date (newest first)
const sortedPosts = postsWithFrontmatter.sort((a, b) => {
  const dateA = a.frontmatter.date ? new Date(a.frontmatter.date).getTime() : 0;
  const dateB = b.frontmatter.date ? new Date(b.frontmatter.date).getTime() : 0;
  return dateB - dateA;
});

// Get the latest post
const latestPost = sortedPosts[0];

// Redirect to the latest post - use 301 for permanent redirect
if (latestPost) {
  // Remove file extension properly
  const cleanPath = latestPost.id.replace(/\.mdx?$/, '');
  return Astro.redirect(`/${cleanPath}/`, 301);
}

// Fallback if no posts exist
return Astro.redirect('/posts/welcome-to-devcult-blog/', 301);
---
