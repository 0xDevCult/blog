---
---

<starlight-theme-select>
	<div class="theme-select-wrapper">
		<button class="theme-button" data-theme="dark" aria-label="Dark theme" title="Dark theme">
			<span class="theme-icon">☾</span>
			<span class="theme-label">Dark</span>
		</button>
		<button class="theme-button" data-theme="light" aria-label="Light theme" title="Light theme">
			<span class="theme-icon">☀</span>
			<span class="theme-label">Light</span>
		</button>
		<button class="theme-button active" data-theme="auto" aria-label="Auto theme" title="Auto theme">
			<span class="theme-icon">⌘</span>
			<span class="theme-label">Auto</span>
		</button>
	</div>
</starlight-theme-select>

<script>
	type Theme = 'auto' | 'dark' | 'light';

	/** Key in `localStorage` to store color theme preference at. */
	const storageKey = 'starlight-theme';

	/** Get a typesafe theme string from any JS value (unknown values are coerced to `'auto'`). */
	const parseTheme = (theme: unknown): Theme =>
		theme === 'auto' || theme === 'dark' || theme === 'light' ? theme : 'auto';

	/** Load the user's preference from `localStorage`. */
	const loadTheme = (): Theme =>
		parseTheme(typeof localStorage !== 'undefined' && localStorage.getItem(storageKey));

	/** Store the user's preference in `localStorage`. */
	function storeTheme(theme: Theme): void {
		if (typeof localStorage !== 'undefined') {
			localStorage.setItem(storageKey, theme === 'light' || theme === 'dark' ? theme : '');
		}
	}

	/** Get the preferred system color scheme. */
	const getPreferredColorScheme = (): Theme =>
		matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';

	/** Update button UI, document theme, and local storage state. */
	function onThemeChange(theme: Theme): void {
		document.documentElement.dataset.theme = theme === 'auto' ? getPreferredColorScheme() : theme;
		storeTheme(theme);

		// Update active button in all theme selects
		document.querySelectorAll('starlight-theme-select').forEach((themeSelect) => {
			const buttons = themeSelect.querySelectorAll('.theme-button');
			buttons.forEach((button) => {
				if (button instanceof HTMLElement) {
					button.classList.toggle('active', button.dataset.theme === theme);
				}
			});
		});
	}

	// React to changes in system color scheme.
	matchMedia(`(prefers-color-scheme: light)`).addEventListener('change', () => {
		if (loadTheme() === 'auto') onThemeChange('auto');
	});

	class StarlightThemeSelect extends HTMLElement {
		constructor() {
			super();
			const currentTheme = loadTheme();
			onThemeChange(currentTheme);

			// Update active button on initialization
			const buttons = this.querySelectorAll('.theme-button');
			buttons.forEach((button) => {
				if (button instanceof HTMLElement) {
					button.classList.toggle('active', button.dataset.theme === currentTheme);
					button.addEventListener('click', () => {
						const theme = button.dataset.theme as Theme;
						if (theme) {
							onThemeChange(theme);
						}
					});
				}
			});
		}
	}
	customElements.define('starlight-theme-select', StarlightThemeSelect);
</script>

<style>
	.theme-select-wrapper {
		display: flex;
		gap: 0.25rem;
		align-items: center;
	}

	.theme-button {
		background: transparent;
		border: 1px solid var(--color-border-primary);
		border-radius: var(--radius-sm);
		padding: 0.375rem;
		cursor: pointer;
		transition: all 0.2s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		min-width: 2rem;
		height: 2rem;
		gap: 0.375rem;
	}

	.theme-button:hover {
		border-color: var(--color-brand-500);
		background-color: rgba(255, 106, 0, 0.1);
	}

	.theme-button.active {
		border-color: var(--color-brand-500);
		background-color: rgba(255, 106, 0, 0.15);
	}

	.theme-icon {
		font-size: 1.125rem;
		line-height: 1;
		display: block;
		color: var(--color-brand-500);
	}

	.theme-label {
		display: none;
	}

	.theme-button.active .theme-label {
		display: inline;
		margin-left: 0.375rem;
		font-size: 0.875rem;
		color: var(--color-brand-500);
	}
</style>
